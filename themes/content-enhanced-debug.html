<!-- OpenList ä¸»é¢˜ - å¢å¼ºè¯Šæ–­ç‰ˆæœ¬ -->
<div id="openlist-theme-container">
  <style>
    .theme-status {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .status-title {
      font-weight: bold;
      color: #495057;
      margin-bottom: 10px;
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 5px;
    }
    .status-item {
      display: inline-block;
      margin: 5px 10px 5px 0;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
    }
    .status-checking { background: #fff3cd; color: #856404; }
    .status-success { background: #d4edda; color: #155724; }
    .status-error { background: #f8d7da; color: #721c24; }
    .music-player {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      color: white;
      text-align: center;
    }
    .stats-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      margin: 15px 0;
    }
    .stat-item {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      color: white;
      padding: 10px 15px;
      border-radius: 20px;
      margin: 5px;
      font-size: 14px;
    }
    .debug-log {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin: 15px 0;
    }
    .log-entry {
      margin: 2px 0;
      padding: 2px 0;
    }
    .log-info { color: #63b3ed; }
    .log-success { color: #68d391; }
    .log-warning { color: #fbb862; }
    .log-error { color: #fc8181; }
    .init-attempts {
      background: #e6fffa;
      border-left: 4px solid #38b2ac;
      padding: 10px;
      margin: 10px 0;
    }
  </style>

  <!-- å¢å¼ºè¯Šæ–­çŠ¶æ€åŒº -->
  <div class="theme-status">
    <div class="status-title">ğŸ”§ OpenList ä¸»é¢˜å¢å¼ºè¯Šæ–­</div>
    <div id="enhanced-status-display">
      <span class="status-item status-checking">ğŸ”„ åˆå§‹åŒ–æ£€æŸ¥...</span>
    </div>
    <div class="init-attempts">
      <strong>åˆå§‹åŒ–å°è¯•:</strong> <span id="init-attempts-count">0</span> æ¬¡
      <br><strong>æœ€åå°è¯•æ—¶é—´:</strong> <span id="last-attempt-time">æœªå¼€å§‹</span>
    </div>
  </div>

  <!-- è°ƒè¯•æ—¥å¿—åŒº -->
  <div class="theme-status">
    <div class="status-title">ğŸ“‹ å®æ—¶è°ƒè¯•æ—¥å¿—</div>
    <div id="debug-log-container" class="debug-log">
      <div class="log-entry log-info">[INFO] è°ƒè¯•ç³»ç»Ÿå·²å¯åŠ¨</div>
    </div>
    <button onclick="clearDebugLog()" style="margin-top: 10px; padding: 5px 10px; background: #4299e1; color: white; border: none; border-radius: 4px;">æ¸…é™¤æ—¥å¿—</button>
  </div>

  <!-- éŸ³ä¹æ’­æ”¾å™¨åŒºåŸŸ -->
  <div class="music-player">
    <h4>ğŸµ éŸ³ä¹æ’­æ”¾å™¨æµ‹è¯•ï¼š</h4>
    <div id="meting-player-container">
      <div id="music-player-placeholder" style="padding: 20px; background: rgba(255,255,255,0.1); border-radius: 8px; margin: 10px 0;">
        ç­‰å¾…éŸ³ä¹æ’­æ”¾å™¨åŠ è½½...
      </div>
    </div>
  </div>

  <!-- è¯„è®ºç³»ç»ŸåŒºåŸŸ -->
  <div class="theme-status">
    <div class="status-title">ğŸ’¬ è¯„è®ºç³»ç»Ÿæµ‹è¯•ï¼š</div>
    <div style="margin: 10px 0; color: #666;">
      ä»“åº“: <code>{{GISCUS_REPO}}</code>
      ä»“åº“ID: <code>{{GISCUS_REPO_ID}}</code>
      åˆ†ç±»: <code>{{GISCUS_CATEGORY}}</code>
      åˆ†ç±»ID: <code>{{GISCUS_CATEGORY_ID}}</code>
    </div>
    <div id="giscus-container">
      <div id="giscus-placeholder" style="padding: 20px; background: #f8f9fa; border: 1px dashed #dee2e6; border-radius: 8px; text-align: center; color: #6c757d;">
        è¯„è®ºç³»ç»ŸåŠ è½½ä¸­...
      </div>
    </div>
  </div>

  <!-- ç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ -->
  <div class="theme-status">
    <div class="status-title">ğŸ“Š è®¿é—®ç»Ÿè®¡ï¼š</div>
    <div class="stats-container">
      <div class="stat-item">
        æœ¬é¡µé¢è®¿é—®é‡ <span id="busuanzi_value_page_pv">-</span> æ¬¡
      </div>
      <div class="stat-item">
        æœ¬ç«™æ€»è®¿é—®é‡ <span id="busuanzi_value_site_pv">-</span> æ¬¡
      </div>
      <div class="stat-item">
        æœ¬ç«™æ€»è®¿å®¢æ•° <span id="busuanzi_value_site_uv">-</span> äºº
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  let initAttempts = 0;
  let debugLogs = [];
  let statusChecks = {
    aplayer: false,
    meting: false,
    giscus: false,
    busuanzi: false
  };

  // å¢å¼ºæ—¥å¿—å‡½æ•°
  function addDebugLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}`;
    debugLogs.push({timestamp, type, message, entry: logEntry});
    
    // æ›´æ–°é¡µé¢æ˜¾ç¤º
    const container = document.getElementById('debug-log-container');
    if (container) {
      const logElement = document.createElement('div');
      logElement.className = `log-entry log-${type}`;
      logElement.textContent = logEntry;
      container.appendChild(logElement);
      container.scrollTop = container.scrollHeight;
      
      // é™åˆ¶æ—¥å¿—æ¡æ•°
      if (container.children.length > 50) {
        container.removeChild(container.firstChild);
      }
    }
    
    // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
    console.log(`OpenList Debug: ${logEntry}`);
  }

  // æ¸…é™¤æ—¥å¿—å‡½æ•°
  window.clearDebugLog = function() {
    debugLogs = [];
    const container = document.getElementById('debug-log-container');
    if (container) {
      container.innerHTML = '<div class="log-entry log-info">[INFO] æ—¥å¿—å·²æ¸…é™¤</div>';
    }
  };

  // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
  function updateStatusDisplay() {
    const statusDisplay = document.getElementById('enhanced-status-display');
    const attemptsCount = document.getElementById('init-attempts-count');
    const lastAttemptTime = document.getElementById('last-attempt-time');
    
    if (attemptsCount) attemptsCount.textContent = initAttempts;
    if (lastAttemptTime) lastAttemptTime.textContent = new Date().toLocaleString();
    
    if (!statusDisplay) return;
    
    let statusHTML = '';
    const checks = [
      {key: 'aplayer', name: 'APlayer', check: () => window.APlayer},
      {key: 'meting', name: 'MetingJS', check: () => window.MetingJSPlugin || window.meting},
      {key: 'giscus', name: 'Giscus', check: () => document.querySelector('.giscus') || document.querySelector('[data-giscus]')},
      {key: 'busuanzi', name: 'ä¸è’œå­ç»Ÿè®¡', check: () => document.getElementById('busuanzi_value_site_pv') && document.getElementById('busuanzi_value_site_pv').textContent !== '-'}
    ];
    
    checks.forEach(({key, name, check}) => {
      try {
        const isLoaded = check();
        statusChecks[key] = !!isLoaded;
        const status = isLoaded ? 'success' : 'checking';
        const icon = isLoaded ? 'âœ…' : 'ğŸ”„';
        statusHTML += `<span class="status-item status-${status}">${icon} ${name}${isLoaded ? '' : '...'}</span>`;
        
        if (isLoaded && !debugLogs.some(log => log.message.includes(`${name} æ£€æµ‹æˆåŠŸ`))) {
          addDebugLog(`${name} æ£€æµ‹æˆåŠŸ`, 'success');
        }
      } catch (error) {
        statusChecks[key] = false;
        statusHTML += `<span class="status-item status-error">âŒ ${name}</span>`;
        addDebugLog(`${name} æ£€æµ‹é”™è¯¯: ${error.message}`, 'error');
      }
    });
    
    statusDisplay.innerHTML = statusHTML;
  }

  // åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
  function initMusicPlayer() {
    addDebugLog('å¼€å§‹åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨');
    
    if (window.APlayer && (window.MetingJSPlugin || window.meting)) {
      try {
        const container = document.getElementById('meting-player-container');
        if (container && !container.querySelector('.aplayer')) {
          const metingEl = document.createElement('meting-js');
          metingEl.setAttribute('server', '{{MUSIC_SERVER}}' || 'netease');
          metingEl.setAttribute('type', '{{MUSIC_TYPE}}' || 'playlist');
          metingEl.setAttribute('id', '{{MUSIC_ID}}' || '2884035');
          metingEl.setAttribute('theme', '{{MUSIC_THEME}}' || '#2980b9');
          metingEl.setAttribute('auto', '{{MUSIC_AUTO}}' || 'https://api.injahow.cn/meting/');
          metingEl.setAttribute('fixed', 'false');
          metingEl.setAttribute('mini', 'false');
          metingEl.setAttribute('list-folded', 'false');
          metingEl.setAttribute('list-max-height', '300px');
          
          // æ¸…é™¤å ä½ç¬¦
          const placeholder = document.getElementById('music-player-placeholder');
          if (placeholder) placeholder.remove();
          
          container.appendChild(metingEl);
          addDebugLog('éŸ³ä¹æ’­æ”¾å™¨å…ƒç´ å·²åˆ›å»º', 'success');
        }
      } catch (error) {
        addDebugLog(`éŸ³ä¹æ’­æ”¾å™¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
      }
    } else {
      const missing = [];
      if (!window.APlayer) missing.push('APlayer');
      if (!window.MetingJSPlugin && !window.meting) missing.push('MetingJS');
      addDebugLog(`éŸ³ä¹æ’­æ”¾å™¨ä¾èµ–ç¼ºå¤±: ${missing.join(', ')}`, 'warning');
    }
  }

  // åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ
  function initGiscus() {
    addDebugLog('å¼€å§‹åˆå§‹åŒ– Giscus è¯„è®ºç³»ç»Ÿ');
    
    // æ£€æŸ¥å˜é‡æ˜¯å¦å·²æ›¿æ¢
    const repo = '{{GISCUS_REPO}}';
    const repoId = '{{GISCUS_REPO_ID}}';
    const category = '{{GISCUS_CATEGORY}}';
    const categoryId = '{{GISCUS_CATEGORY_ID}}';
    
    if (repo.includes('{{') || repoId.includes('{{')) {
      addDebugLog('Giscus é…ç½®å˜é‡æœªæ›¿æ¢ï¼Œè·³è¿‡åˆå§‹åŒ–', 'warning');
      return;
    }
    
    const container = document.getElementById('giscus-container');
    if (!container || container.querySelector('.giscus')) {
      addDebugLog('Giscus å®¹å™¨ä¸å­˜åœ¨æˆ–å·²åˆå§‹åŒ–', 'info');
      return;
    }
    
    try {
      // æ¸…é™¤å ä½ç¬¦
      const placeholder = document.getElementById('giscus-placeholder');
      if (placeholder) placeholder.remove();
      
      const script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.setAttribute('data-repo', repo);
      script.setAttribute('data-repo-id', repoId);
      script.setAttribute('data-category', category);
      script.setAttribute('data-category-id', categoryId);
      script.setAttribute('data-mapping', 'pathname');
      script.setAttribute('data-strict', '0');
      script.setAttribute('data-reactions-enabled', '1');
      script.setAttribute('data-emit-metadata', '0');
      script.setAttribute('data-input-position', 'bottom');
      script.setAttribute('data-theme', 'light');
      script.setAttribute('data-lang', 'zh-CN');
      script.crossOrigin = 'anonymous';
      script.async = true;
      
      script.onload = () => addDebugLog('Giscus è„šæœ¬åŠ è½½æˆåŠŸ', 'success');
      script.onerror = () => addDebugLog('Giscus è„šæœ¬åŠ è½½å¤±è´¥', 'error');
      
      container.appendChild(script);
      addDebugLog('Giscus è„šæœ¬å·²æ’å…¥DOM', 'info');
    } catch (error) {
      addDebugLog(`Giscus åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
    }
  }

  // ä¸»è¦åˆå§‹åŒ–å‡½æ•°
  function initializeComponents() {
    initAttempts++;
    addDebugLog(`ç¬¬ ${initAttempts} æ¬¡åˆå§‹åŒ–å°è¯•`, 'info');
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updateStatusDisplay();
    
    // åˆå§‹åŒ–å„ä¸ªç»„ä»¶
    initMusicPlayer();
    initGiscus();
    
    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç»„ä»¶éƒ½å·²åŠ è½½
    const allLoaded = Object.values(statusChecks).every(status => status);
    if (allLoaded) {
      addDebugLog('æ‰€æœ‰ç»„ä»¶åˆå§‹åŒ–å®Œæˆï¼', 'success');
      return true;
    }
    
    return false;
  }

  // å¤šé‡åˆå§‹åŒ–ç­–ç•¥
  function startInitialization() {
    addDebugLog('å¼€å§‹å¤šé‡åˆå§‹åŒ–ç­–ç•¥', 'info');
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    setTimeout(() => {
      if (!initializeComponents()) {
        addDebugLog('ç«‹å³åˆå§‹åŒ–æœªå®Œæˆï¼Œå¯åŠ¨å»¶è¿Ÿé‡è¯•', 'warning');
      }
    }, 100);
    
    // å»¶è¿Ÿé‡è¯•
    const retryIntervals = [500, 1000, 2000, 3000, 5000];
    retryIntervals.forEach((delay, index) => {
      setTimeout(() => {
        if (!Object.values(statusChecks).every(status => status)) {
          addDebugLog(`å»¶è¿Ÿé‡è¯• ${index + 1} (${delay}ms)`, 'info');
          initializeComponents();
        }
      }, delay);
    });
    
    // å®šæœŸæ£€æŸ¥
    const checkInterval = setInterval(() => {
      updateStatusDisplay();
      if (initAttempts < 10 && !Object.values(statusChecks).every(status => status)) {
        initializeComponents();
      }
      if (initAttempts >= 10) {
        clearInterval(checkInterval);
        addDebugLog('è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢è‡ªåŠ¨é‡è¯•', 'warning');
      }
    }, 3000);
  }

  // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startInitialization);
  } else {
    startInitialization();
  }
  
  // ç›‘å¬å¤–éƒ¨è„šæœ¬åŠ è½½
  window.addEventListener('load', () => {
    addDebugLog('é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ', 'info');
    setTimeout(initializeComponents, 1000);
  });

})();
</script>

<!-- ä¾èµ–åŠ è½½è„šæœ¬ -->
<script>
(function() {
  'use strict';
  
  const cdnList = {
    aplayer: [
      'https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css',
      'https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js'
    ],
    meting: [
      'https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js',
      'https://unpkg.com/meting@2/dist/Meting.min.js'
    ],
    busuanzi: [
      'https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js',
      'https://cdn.jsdelivr.net/npm/busuanzi@2.3.0/bsz.pure.mini.js'
    ]
  };

  function loadResource(url, type = 'auto') {
    return new Promise((resolve, reject) => {
      let element;
      
      if (type === 'auto') {
        type = url.endsWith('.css') ? 'css' : 'js';
      }
      
      if (type === 'css') {
        element = document.createElement('link');
        element.rel = 'stylesheet';
        element.href = url;
      } else {
        element = document.createElement('script');
        element.src = url;
        element.async = true;
      }
      
      element.onload = () => {
        console.log(`èµ„æºåŠ è½½æˆåŠŸ: ${url}`);
        resolve(url);
      };
      element.onerror = () => {
        console.error(`èµ„æºåŠ è½½å¤±è´¥: ${url}`);
        reject(new Error(`Failed to load ${url}`));
      };
      
      document.head.appendChild(element);
    });
  }

  async function loadWithFallback(urls) {
    for (const url of urls) {
      try {
        await loadResource(url);
        return url;
      } catch (error) {
        console.warn(`Fallback loading: ${error.message}`);
        continue;
      }
    }
    throw new Error(`All fallback URLs failed: ${urls.join(', ')}`);
  }

  // åŠ è½½æ‰€æœ‰ä¾èµ–
  async function loadAllDependencies() {
    console.log('å¼€å§‹åŠ è½½ OpenList ä¸»é¢˜ä¾èµ–...');
    
    try {
      // å¹¶è¡ŒåŠ è½½æ‰€æœ‰ä¾èµ–
      await Promise.all([
        loadWithFallback(cdnList.aplayer),
        loadWithFallback(cdnList.meting),
        loadWithFallback(cdnList.busuanzi)
      ]);
      
      console.log('æ‰€æœ‰ä¾èµ–åŠ è½½å®Œæˆ');
      
      // è§¦å‘åˆå§‹åŒ–æ£€æŸ¥
      if (window.initializeComponents) {
        setTimeout(window.initializeComponents, 500);
      }
    } catch (error) {
      console.error('ä¾èµ–åŠ è½½å¤±è´¥:', error);
    }
  }

  // å¼€å§‹åŠ è½½
  loadAllDependencies();
})();
</script>
