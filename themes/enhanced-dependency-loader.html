<!-- OpenList ä¸»é¢˜ - æ”¹è¿›çš„ä¾èµ–åŠ è½½è„šæœ¬ -->
<script>
console.log('ğŸš€ OpenList ä¸»é¢˜ä¾èµ–åŠ è½½å™¨å¯åŠ¨');

// ä¾èµ–åŠ è½½å‡½æ•°
function loadDependency(url, type = 'auto') {
  return new Promise((resolve, reject) => {
    let element;
    
    if (type === 'auto') {
      type = url.endsWith('.css') ? 'css' : 'js';
    }
    
    if (type === 'css') {
      element = document.createElement('link');
      element.rel = 'stylesheet';
      element.href = url;
    } else {
      element = document.createElement('script');
      element.src = url;
      element.async = true;
    }
    
    element.onload = () => {
      console.log(`âœ… ä¾èµ–åŠ è½½æˆåŠŸ: ${url}`);
      resolve(url);
    };
    
    element.onerror = () => {
      console.error(`âŒ ä¾èµ–åŠ è½½å¤±è´¥: ${url}`);
      reject(new Error(`Failed to load ${url}`));
    };
    
    document.head.appendChild(element);
  });
}

// å¤‡ç”¨ CDN åˆ—è¡¨
const cdnOptions = {
  aplayer: {
    css: [
      'https://npm.elemecdn.com/aplayer@1.10.1/dist/APlayer.min.css',
      'https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css',
      'https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.css'
    ],
    js: [
      'https://npm.elemecdn.com/aplayer@1.10.1/dist/APlayer.min.js',
      'https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js',
      'https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js'
    ]
  },
  meting: [
    'https://npm.elemecdn.com/meting2@0.0.1/js/Meting.min.js',
    'https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js',
    'https://unpkg.com/meting@2/dist/Meting.min.js',
    'https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js'
  ]
};

// å¸¦é‡è¯•çš„åŠ è½½å‡½æ•°
async function loadWithRetry(urls, maxRetries = 3) {
  if (!Array.isArray(urls)) urls = [urls];
  
  for (const url of urls) {
    for (let retry = 0; retry < maxRetries; retry++) {
      try {
        await loadDependency(url);
        return url;
      } catch (error) {
        console.warn(`å°è¯• ${retry + 1}/${maxRetries} åŠ è½½ ${url} å¤±è´¥`);
        if (retry === maxRetries - 1) {
          continue; // å°è¯•ä¸‹ä¸€ä¸ª URL
        }
        // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }
  }
  throw new Error(`æ‰€æœ‰ URL éƒ½åŠ è½½å¤±è´¥: ${urls.join(', ')}`);
}

// æ£€æŸ¥ä¾èµ–æ˜¯å¦å·²åŠ è½½
function checkDependencyLoaded() {
  const status = {
    aplayer: !!window.APlayer,
    meting: !!(window.MetingJSElement || window.MetingJSPlugin || window.meting || 
              (window.customElements && window.customElements.get('meting-js')))
  };
  
  console.log('ä¾èµ–æ£€æŸ¥ç»“æœ:', status);
  return status;
}

// ä¸»åŠ è½½å‡½æ•°
async function loadAllDependencies() {
  try {
    console.log('å¼€å§‹åŠ è½½ OpenList ä¸»é¢˜ä¾èµ–...');
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½
    let status = checkDependencyLoaded();
    
    if (!status.aplayer) {
      console.log('åŠ è½½ APlayer...');
      try {
        await loadWithRetry(cdnOptions.aplayer.css);
        await loadWithRetry(cdnOptions.aplayer.js);
        console.log('âœ… APlayer åŠ è½½å®Œæˆ');
      } catch (error) {
        console.error('âŒ APlayer åŠ è½½å¤±è´¥:', error);
      }
    } else {
      console.log('âœ… APlayer å·²å­˜åœ¨');
    }
    
    if (!status.meting) {
      console.log('åŠ è½½ MetingJS...');
      try {
        await loadWithRetry(cdnOptions.meting);
        console.log('âœ… MetingJS åŠ è½½å®Œæˆ');
        
        // ç­‰å¾… MetingJS åˆå§‹åŒ–
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // å†æ¬¡æ£€æŸ¥
        status = checkDependencyLoaded();
        if (status.meting) {
          console.log('âœ… MetingJS éªŒè¯é€šè¿‡');
        } else {
          console.warn('âš ï¸ MetingJS åŠ è½½åéªŒè¯å¤±è´¥');
        }
      } catch (error) {
        console.error('âŒ MetingJS åŠ è½½å¤±è´¥:', error);
      }
    } else {
      console.log('âœ… MetingJS å·²å­˜åœ¨');
    }
    
    // æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
    setTimeout(() => {
      const finalStatus = checkDependencyLoaded();
      console.log('ğŸ” æœ€ç»ˆä¾èµ–çŠ¶æ€:', finalStatus);
      
      // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–è„šæœ¬ä¾èµ–å·²åŠ è½½
      const event = new CustomEvent('openlistDependenciesLoaded', {
        detail: finalStatus
      });
      document.dispatchEvent(event);
    }, 2000);
    
  } catch (error) {
    console.error('âŒ ä¾èµ–åŠ è½½è¿‡ç¨‹å‡ºé”™:', error);
  }
}

// å¯åŠ¨åŠ è½½
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadAllDependencies);
} else {
  setTimeout(loadAllDependencies, 100);
}

// é¡µé¢å®Œå…¨åŠ è½½åå†æ£€æŸ¥ä¸€æ¬¡
window.addEventListener('load', () => {
  setTimeout(() => {
    const status = checkDependencyLoaded();
    if (!status.aplayer || !status.meting) {
      console.log('é¡µé¢åŠ è½½å®Œæˆåé‡æ–°å°è¯•åŠ è½½ç¼ºå¤±çš„ä¾èµ–');
      loadAllDependencies();
    }
  }, 1000);
});

console.log('ğŸ¯ OpenList ä¸»é¢˜ä¾èµ–åŠ è½½å™¨å·²åˆå§‹åŒ–');
</script>
