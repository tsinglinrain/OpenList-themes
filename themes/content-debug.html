<!-- OpenList 主题 - 诊断版本 -->
<div id="openlist-theme-debug" style="max-width: 100%; margin: 0 auto; padding: 0;">
    
    <!-- 依赖检查状态显示 -->
    <div id="debug-status" style="background: #f0f8ff; border: 1px solid #409EFF; padding: 10px; margin: 10px 0; font-size: 12px;">
        <h4 style="color: #409EFF; margin: 0 0 10px 0;">🔧 OpenList 主题诊断</h4>
        <div id="aplayer-status">🔄 检查 APlayer...</div>
        <div id="meting-status">🔄 检查 MetingJS...</div>
        <div id="giscus-status">🔄 检查 Giscus...</div>
        <div id="config-status" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;">
            <strong>配置检查：</strong>
            <div id="config-details" style="font-size: 11px; margin-top: 5px;"></div>
        </div>
        <div id="error-log" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; color: #d73a49; font-family: monospace; font-size: 11px; max-height: 150px; overflow-y: auto;">
            <strong>错误日志：</strong>
            <div id="error-messages"></div>
        </div>
    </div>

	<!--音乐播放器-->
    <div style="margin: 10px 0; padding: 10px; border: 1px dashed #ccc;">
        <h4>音乐播放器测试：</h4>
        <meting-js 
            list-folded="true" 
            server="{{MUSIC_SERVER}}" 
            type="playlist" 
            id="{{PLAYLIST_ID}}" 
            fixed="false"
            style="max-width: 100%;">
            <pre hidden>
                [00:00.00]This
                [00:04.01]is
                [00:08.02]Waite
            </pre>
        </meting-js>
        <div id="meting-debug" style="margin-top: 5px; font-size: 11px; color: #666;"></div>
    </div>

    <br />
    <center class="dibu">
        <div style="line-height: 20px;font-size: 9pt;font-weight: bold; max-width: 100%;">
            <span>
                "
                <span style="color: rgb(13, 109, 252); font-weight: bold;" id="hitokoto">
                    <a href="#" id="hitokoto_text">
                        "{{DEFAULT_QUOTE}}"
                    </a>
                </span> "
            </span>
            <p style="margin-left: 10rem;font-size: 8pt;">
                <small>
                    —— {{QUOTE_AUTHOR}}
                </small>
            </p>
        </div>

        <div style="font-size: 13px; font-weight: bold; max-width: 100%; word-wrap: break-word;">
            
            <span class="nav-item">
                <a class="nav-link" href="mailto:{{EMAIL}}" target="_blank">
                    <i class="fa-duotone fa-envelope-open" style="color:#409EFF" aria-hidden="true">
                    </i>
                    邮箱 |
                </a>
            </span>
            <span class="nav-item">
                <a class="nav-link" href="{{BLOG_URL}}" target="_blank">
                    <i class="fas fa-edit" style="color:#409EFF" aria-hidden="true">
                    </i>
                    博客 |
                </a>
            </span>
            
            <span class="nav-item">
                <a class="nav-link" href="{{CLOUD_URL}}" target="_blank">
                    <i class="fa fa-cloud-download" style="color:#409EFF;" aria-hidden="true">
                    </i>
                    云盘 |
                </a>
            </span>
            <!--后台入口-->
            <span class="nav-item">
                <a class="nav-link" href="/@manage" target="_blank">
                    <i class="fa-solid fa-folder-gear" style="color:#409EFF;" aria-hidden="true">
                    </i>
                    管理 |
                </a>
            </span>
            <!--版权，请尊重作者-->
            <span class="nav-item">
                <a class="nav-link" href="https://github.com/OpenListTeam/OpenList" target="_blank">
                    <i class="fa-solid fa-copyright" style="color:#409EFF;" aria-hidden="true">
                    </i>
                    Openlist
                </a>
            </span>
            <br />
            <!--添加备案信息-->
            <span class="nav-item">
                <a class="nav-link" href="https://beian.miit.gov.cn/#/Integrated/index" target="_blank">
                    <i class="fa-solid fa-shield-check" style="color:#409EFF;" aria-hidden="true">
                    </i>
                    {{ICP_RECORD}}
                </a>
            </span>
        </div>
    </center>
    <br />

    <!--评论模块-->
    <div style="margin: 10px 0; padding: 10px; border: 1px dashed #ccc;">
        <h4>评论系统测试：</h4>
        <div style="font-size: 12px; margin-bottom: 10px;">
            <div>仓库: <code>{{GISCUS_REPO}}</code></div>
            <div>仓库ID: <code>{{GISCUS_REPO_ID}}</code></div>
            <div>分类: <code>{{GISCUS_CATEGORY}}</code></div>
            <div>分类ID: <code>{{GISCUS_CATEGORY_ID}}</code></div>
        </div>
        <center>
            <div class="giscus" id="giscus" style="max-width: 100%; box-sizing: border-box; min-height: 100px; border: 1px solid #eee; padding: 10px;">
                <div style="text-align: center; color: #666; padding: 20px;">
                    评论系统加载中...
                </div>
            </div>
        </center>
    </div>
</div>

<!--一言API-->
<script src="https://v1.hitokoto.cn/?encode=js&select=%23hitokoto" defer></script>

<script>
console.log("🔧 OpenList主题诊断版本开始加载");

// 错误日志收集
const errorLog = [];

function logError(message) {
    errorLog.push(`${new Date().toLocaleTimeString()}: ${message}`);
    console.error('❌ ' + message);
    
    // 更新页面上的错误显示
    const errorDiv = document.getElementById('error-messages');
    if (errorDiv) {
        errorDiv.innerHTML = errorLog.map(err => `<div>${err}</div>`).join('');
    }
}

function logInfo(message) {
    console.log('ℹ️ ' + message);
}

// 手动初始化 Giscus 的函数
function initializeGiscus(config) {
    logInfo(`手动初始化 Giscus: ${JSON.stringify(config)}`);
    
    const giscusContainer = document.getElementById('giscus');
    if (!giscusContainer) {
        logError('未找到 Giscus 容器元素');
        return;
    }
    
    // 清空容器
    giscusContainer.innerHTML = '<div style="text-align: center; color: #666; padding: 10px;">正在初始化评论系统...</div>';
    
    // 创建新的 script 元素来重新初始化 Giscus
    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', config.repo);
    script.setAttribute('data-repo-id', config.repoId);
    script.setAttribute('data-category', config.category);
    script.setAttribute('data-category-id', config.categoryId);
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'bottom');
    script.setAttribute('data-theme', 'preferred_color_scheme');
    script.setAttribute('data-lang', 'zh-CN');
    script.crossOrigin = 'anonymous';
    script.async = true;
    
    // 添加加载监听
    script.onload = () => {
        logInfo('Giscus 重新加载成功');
        updateStatus('giscus-status', '✅', 'Giscus 手动初始化成功');
    };
    
    script.onerror = (error) => {
        logError(`Giscus 重新加载失败: ${error.message || 'Unknown error'}`);
        updateStatus('giscus-status', '❌', 'Giscus 手动初始化失败');
        giscusContainer.innerHTML = '<div style="text-align: center; color: #f56565; padding: 20px;">❌ 评论系统加载失败，请检查网络连接和仓库配置</div>';
    };
    
    // 超时检查
    setTimeout(() => {
        if (giscusContainer.innerHTML.includes('正在初始化评论系统')) {
            logError('Giscus 初始化超时（10秒）');
            giscusContainer.innerHTML = '<div style="text-align: center; color: #f56565; padding: 20px;">⏰ 评论系统初始化超时</div>';
        }
    }, 10000);
    
    // 将 script 添加到 giscus 容器中
    giscusContainer.appendChild(script);
}

// 诊断函数
function updateStatus(elementId, status, message) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = `${status} ${message}`;
    }
}

// 检查依赖
function checkDependencies() {
    logInfo('开始检查依赖...');
    
    // 检查配置变量替换情况
    const configCheck = {
        MUSIC_SERVER: '{{MUSIC_SERVER}}',
        PLAYLIST_ID: '{{PLAYLIST_ID}}',
        GISCUS_REPO: '{{GISCUS_REPO}}',
        EMAIL: '{{EMAIL}}'
    };
    
    const unresolved = Object.entries(configCheck).filter(([key, value]) => 
        value.includes('{{') && value.includes('}}')
    );
    
    const configDiv = document.getElementById('config-details');
    if (configDiv) {
        if (unresolved.length > 0) {
            configDiv.innerHTML = `❌ 未替换的变量: ${unresolved.map(([k]) => k).join(', ')}`;
            logError(`配置变量未替换: ${unresolved.map(([k, v]) => `${k}=${v}`).join(', ')}`);
        } else {
            configDiv.innerHTML = `✅ 所有配置变量已正确替换`;
            logInfo('配置变量检查通过');
        }
    }

    // 检查 APlayer
    if (typeof APlayer !== 'undefined') {
        updateStatus('aplayer-status', '✅', 'APlayer 已加载');
        logInfo('APlayer 可用');
    } else {
        updateStatus('aplayer-status', '❌', 'APlayer 未加载');
        logError('APlayer 库未加载，可能是 CDN 问题');
    }

    // 检查 MetingJS
    if (typeof MetingJSElement !== 'undefined' || document.querySelector('meting-js')) {
        const metingElements = document.querySelectorAll('meting-js');
        updateStatus('meting-status', '✅', `MetingJS 已加载 (找到 ${metingElements.length} 个元素)`);
        logInfo(`MetingJS 可用，找到 ${metingElements.length} 个元素`);
        
        // 检查 meting-js 元素的状态
        metingElements.forEach((el, index) => {
            const elementInfo = {
                server: el.getAttribute('server'),
                type: el.getAttribute('type'),
                id: el.getAttribute('id'),
                hasPlayer: el.querySelector('.aplayer') !== null
            };
            logInfo(`MetingJS 元素 ${index}: ${JSON.stringify(elementInfo)}`);
            
            if (!elementInfo.hasPlayer) {
                logError(`MetingJS 元素 ${index} 没有生成播放器界面`);
            }
            
            if (elementInfo.server?.includes('{{') || elementInfo.id?.includes('{{')) {
                logError(`MetingJS 元素 ${index} 包含未替换的配置变量`);
            }
        });
    } else {
        updateStatus('meting-status', '❌', 'MetingJS 未加载');
        logError('MetingJS 库未加载或元素未找到');
    }

    // 检查 Giscus
    const giscusScript = document.querySelector('script[src*="giscus"]');
    if (giscusScript) {
        updateStatus('giscus-status', '✅', 'Giscus 脚本已加载');
        console.log('✅ Giscus 脚本存在');
        
        // 检查 Giscus 配置
        const giscusConfig = {
            repo: giscusScript.getAttribute('data-repo'),
            repoId: giscusScript.getAttribute('data-repo-id'),
            category: giscusScript.getAttribute('data-category'),
            categoryId: giscusScript.getAttribute('data-category-id')
        };
        logInfo(`Giscus 配置: ${JSON.stringify(giscusConfig)}`);
        
        // 检查配置是否还有变量占位符
        const hasPlaceholders = Object.values(giscusConfig).some(val => 
            val && val.includes('{{') && val.includes('}}')
        );
        
        if (hasPlaceholders) {
            updateStatus('giscus-status', '⚠️', 'Giscus 配置中还有未替换的变量');
            logError('Giscus 配置中发现未替换变量');
            const unresolvedVars = Object.entries(giscusConfig)
                .filter(([k, v]) => v && v.includes('{{'))
                .map(([k, v]) => `${k}=${v}`);
            logError(`未替换的 Giscus 变量: ${unresolvedVars.join(', ')}`);
        } else if (!giscusConfig.repo || !giscusConfig.repoId) {
            updateStatus('giscus-status', '❌', 'Giscus 配置不完整');
            logError('Giscus 配置不完整，缺少必要参数');
        } else {
            updateStatus('giscus-status', '✅', 'Giscus 脚本已加载，配置正确');
            logInfo('Giscus 脚本存在且配置正确');
            // 手动初始化 Giscus
            setTimeout(() => {
                initializeGiscus(giscusConfig);
            }, 1000);
        }
    } else {
        updateStatus('giscus-status', '❌', 'Giscus 脚本未找到');
        logError('Giscus 脚本未找到，可能是 header.html 未正确加载');
    }
}

// 立即检查一次
setTimeout(checkDependencies, 1000);

// 2秒后再检查一次  
setTimeout(() => {
    checkDependencies();
    console.log('🔧 第二次依赖检查完成');
}, 2000);

// 5秒后最后检查一次
setTimeout(() => {
    checkDependencies();
    console.log('🔧 诊断完成');
    
    // 强制更新所有状态为最终结果
    const statusElements = ['aplayer-status', 'meting-status', 'giscus-status'];
    statusElements.forEach(id => {
        const element = document.getElementById(id);
        if (element && element.innerHTML.includes('🔄')) {
            updateStatus(id, '⚠️', '检查超时');
        }
    });
    
    // 如果音乐播放器还是没有内容，尝试手动初始化
    const metingElements = document.querySelectorAll('meting-js');
    metingElements.forEach((el, index) => {
        if (!el.querySelector('.aplayer')) {
            console.log(`尝试手动初始化 MetingJS 元素 ${index}`);
            // 强制重新渲染
            const server = el.getAttribute('server');
            const type = el.getAttribute('type');
            const id = el.getAttribute('id');
            
            // 重置属性触发重新渲染
            el.setAttribute('server', 'temp');
            setTimeout(() => {
                el.setAttribute('server', server);
                el.setAttribute('type', type);
                el.setAttribute('id', id);
            }, 100);
        }
    });
}, 5000);

function removelrc() {
    if (!document.querySelector(".aplayer-icon-lrc"))
        return;
    else {
        document.removeEventListener("DOMNodeInserted", removelrc);
        setTimeout(function () {
            document.querySelector(".aplayer-icon-lrc").click();
        }, 1);
        console.log("音乐播放器歌词已隐藏");
        return;
    }
}

document.addEventListener('DOMNodeInserted', removelrc)
</script>